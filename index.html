<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gesti√≥n de Legajos v26.5 (Auditor√≠a de Movimientos Real)</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <!-- React & Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
        }

        @keyframes move-gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .background-gradient-animation {
            background: linear-gradient(-45deg, #0f172a, #1e293b, #334155, #020617);
            background-size: 400% 400%;
            animation: move-gradient 15s ease infinite;
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .barcode-scanned {
            box-shadow: 0 0 20px 2px rgba(59, 130, 246, 0.4);
            border-color: rgba(59, 130, 246, 0.5) !important;
        }

        .highlighted-row {
            background: rgba(59, 130, 246, 0.2) !important;
            border-left: 4px solid #3b82f6 !important;
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body class="text-slate-200 antialiased">
    <div id="root"></div>

    <script type="text/babel">
    
    // =======================================================
    //  INICIALIZACI√ìN DE FIREBASE
    // =======================================================
    const firebaseConfig = {
      apiKey: "AIzaSyDCCruZk6UAf2ybjJG6gihuUrJMZduhUI0",
      authDomain: "gestor-legajos-eess.firebaseapp.com",
      projectId: "gestor-legajos-eess",
      storageBucket: "gestor-legajos-eess.appspot.com",
      messagingSenderId: "599295230532",
      appId: "1:599295230532:web:bd18f19ce6317d56987211"
    };

    let db, auth;
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        auth = firebase.auth();
    } catch (e) {
        console.error("Firebase Init Error:", e);
    }

    const legajosCollectionRef = db.collection("legajos");
    const deletedCollectionRef = db.collection("legajos_eliminados");
    const instructoresCollectionRef = db.collection("instructores");

    // =======================================================
    //  UTILIDADES
    // =======================================================
    const DEPENDENCIAS = ["Fiscal√≠a Correccional N¬∞ 1", "Fiscal√≠a Correccional N¬∞ 2", "Fiscal√≠a Correccional N¬∞ 3","Defensor√≠a N¬∞ 1", "Defensor√≠a N¬∞ 2", "Defensor√≠a N¬∞ 3", "Defensor√≠a N¬∞ 4", "Defensor√≠a N¬∞ 5", "Defensor√≠a N¬∞ 6","Gabinete T√©cnico de Ejecuci√≥n", "Corte de Justicia", "Otra"];

    const uid = () => `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
    
    const fmtDateTime = (d) => {
        if (!d) return "‚Äî";
        const date = d.toDate ? d.toDate() : new Date(d);
        if (isNaN(date.getTime())) return "‚Äî";
        return date.toLocaleString("es-AR", { timeZone: "America/Argentina/Catamarca" });
    };

    const isOverdue = (l) => {
        if (!l?.enTransito || !l?.vencimiento) return false;
        const venc = l.vencimiento.toDate ? l.vencimiento.toDate() : new Date(l.vencimiento);
        return venc < new Date();
    };

    const isSameDay = (d1, d2) => {
        if (!d1 || !d2) return false;
        const date1 = d1.toDate ? d1.toDate() : new Date(d1);
        const date2 = d2.toDate ? d2.toDate() : new Date(d2);
        return date1.getDate() === date2.getDate() && date1.getMonth() === date2.getMonth() && date1.getFullYear() === date2.getFullYear();
    };

    const dateToInputString = (date = new Date()) => {
        const d = new Date(date);
        const pad = (num) => num.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    };

    const dateToInputFormat = (date) => {
        if (!date) return '';
        const d = date.toDate ? date.toDate() : new Date(date);
        const pad = (num) => num.toString().padStart(2, '0');
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
    };

    const validateNumeroExpediente = (v) => /^\d{1,10}\/\d{4}$/.test((v || "").trim());
    const addDays = (dateObj, days) => { const d = new Date(dateObj); d.setDate(d.getDate() + Number(days || 0)); return d; };

    // =======================================================
    //  COMPONENTES UI
    // =======================================================
    function BackgroundGradientAnimation() { return <div className="background-gradient-animation"></div>; }

    const Pill = ({ children, color = "gray" }) => {
        const variants = {
            gray: "bg-slate-700 text-slate-300 border-slate-600",
            blue: "bg-blue-500/20 text-blue-400 border-blue-500/30",
            green: "bg-emerald-500/20 text-emerald-400 border-emerald-500/30",
            red: "bg-rose-500/20 text-rose-400 border-rose-500/30",
            purple: "bg-purple-500/20 text-purple-400 border-purple-500/30"
        };
        return <span className={`px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider rounded border ${variants[color]}`}>{children}</span>;
    };

    const ActionButton = ({ onClick, icon, title, color = "slate" }) => {
        const colors = {
            blue: "bg-blue-600 hover:bg-blue-500 text-white",
            green: "bg-emerald-600 hover:bg-emerald-500 text-white",
            red: "bg-rose-600 hover:bg-rose-500 text-white",
            slate: "bg-slate-700 hover:bg-slate-600 text-slate-200 border border-slate-600",
            purple: "bg-purple-600 hover:bg-purple-500 text-white",
            yellow: "bg-amber-600 hover:bg-amber-500 text-white"
        };
        return (
            <button onClick={onClick} title={title} className={`p-2 rounded-lg transition-all active:scale-95 flex items-center justify-center ${colors[color]}`}>
                {icon}
            </button>
        );
    };

    const Modal = ({ open, onClose, title, children, footer, maxWidth = "max-w-xl" }) => {
        if (!open) return null;
        return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm" onClick={onClose}>
                <div className={`relative w-full ${maxWidth} glass-panel rounded-3xl shadow-2xl overflow-hidden`} onClick={e => e.stopPropagation()}>
                    <div className="px-6 py-5 border-b border-white/10 flex justify-between items-center bg-white/5">
                        <h3 className="text-xl font-bold text-white tracking-tight">{title}</h3>
                        <button onClick={onClose} className="text-slate-400 hover:text-white transition-colors">‚úï</button>
                    </div>
                    <div className="p-6 overflow-y-auto max-h-[70vh] text-slate-300">{children}</div>
                    {footer && <div className="px-6 py-4 border-t border-white/10 flex justify-end gap-3 bg-white/5">{footer}</div>}
                </div>
            </div>
        );
    };

    function BarcodeModal({ open, onClose, legajo }) {
        React.useEffect(() => {
            if (open && legajo) {
                try { JsBarcode("#barcode-svg-display", legajo.numero, { format: "CODE128", lineColor: "#000", width: 2.5, height: 80, displayValue: true, text: legajo.numero }); } catch (e) { console.error("Error JSBarcode:", e); }
            }
        }, [open, legajo]);

        const handlePrint = () => {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Imprimir C√≥digo de Barras</title>');
            printWindow.document.write(`
                <style>
                    @page { size: A4; margin: 0; }
                    body { margin: 0; font-family: sans-serif; display: flex; justify-content: flex-end; align-items: flex-end; height: 100vh; }
                    .container { margin-bottom: 1.5cm; margin-right: 1.5cm; }
                </style>
            `);
            printWindow.document.write('</head><body>');
            printWindow.document.write('<div class="container"><svg id="barcode-print"></svg></div>');
            printWindow.document.write('<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>');
            printWindow.document.write('<script>');
            printWindow.document.write(`try { JsBarcode("#barcode-print", "${legajo.numero}", { format: "CODE128", lineColor: "#000", width: 2, height: 100, displayValue: false }); setTimeout(() => { window.print(); window.close(); }, 300); } catch(e) { window.close(); }`);
            printWindow.document.write('<\/script></body></html>');
            printWindow.document.close();
        };
        if (!open || !legajo) return null;
        return (
            <Modal open={open} onClose={onClose} title="Etiqueta de C√≥digo de Barras" 
                   footer={<><button className="px-4 py-2 bg-slate-700 rounded-lg text-xs font-bold" onClick={onClose}>Cerrar</button><button className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold" onClick={handlePrint}>üñ®Ô∏è Imprimir</button></>}>
                <div className="text-center p-6 space-y-4">
                    <div className="flex justify-center bg-white p-4 rounded-lg shadow-inner"><svg id="barcode-svg-display"></svg></div>
                    <p className="text-sm text-slate-400 italic">Posici√≥n de impresi√≥n: Esquina inferior derecha (A4).</p>
                </div>
            </Modal>
        );
    }

    function InstructoresModal({ open, onClose, instructores, legajos, onAdd, onEdit, onDelete, onAlert }) {
        const [newName, setNewName] = React.useState('');
        const [editing, setEditing] = React.useState(null);
        const handleAdd = () => {
            const n = newName.trim();
            if (!n) return onAlert('Ingrese un nombre.');
            onAdd(n); setNewName('');
        };
        return (
            <Modal open={open} onClose={onClose} title="Gesti√≥n de Personal" footer={<button className="px-4 py-2 bg-slate-700 rounded-lg text-xs font-bold" onClick={onClose}>Cerrar</button>}>
                <div className="space-y-4">
                    <div className="flex gap-2">
                        <input type="text" value={newName} onChange={e => setNewName(e.target.value)} placeholder="Nuevo instructor" className="p-3 bg-slate-900 border border-white/10 rounded-xl w-full text-sm"/>
                        <button onClick={handleAdd} className="px-4 py-2 bg-blue-600 text-white rounded-xl text-xs font-bold">A√±adir</button>
                    </div>
                    <ul className="space-y-2">
                        {instructores.map(i => (
                            <li key={i.id} className="flex justify-between items-center p-3 bg-white/5 rounded-xl">
                                {editing?.id === i.id ? (
                                    <input type="text" value={editing.nombre} onChange={e => setEditing({...editing, nombre: e.target.value})} className="bg-slate-800 border border-white/20 p-1 rounded w-full mr-2 text-white"/>
                                ) : ( <span>{i.nombre}</span> )}
                                <div className="flex gap-1">
                                    {editing?.id === i.id ? (
                                        <button onClick={() => { onEdit(editing.id, editing.nombre); setEditing(null); }} className="px-3 py-1 bg-green-600 text-white rounded text-xs font-bold">OK</button>
                                    ) : (
                                        <>
                                            <button onClick={() => setEditing(i)} className="px-3 py-1 bg-slate-600 text-white rounded text-xs font-bold">Editar</button>
                                            <button onClick={() => {
                                                if (legajos.some(l => l.instructorId === i.id)) onAlert('El instructor tiene legajos asignados.');
                                                else onDelete(i.id);
                                            }} className="px-3 py-1 bg-rose-600 text-white rounded text-xs font-bold">Borrar</button>
                                        </>
                                    )}
                                </div>
                            </li>
                        ))}
                    </ul>
                </div>
            </Modal>
        );
    }

    function ReporteModal({ open, onClose, type, legajos, onPrint }) {
        const [selected, setSelected] = React.useState(new Set());
        const [date, setDate] = React.useState(dateToInputString());
        
        // --- MEJORA: L√≥gica de auditor√≠a real ---
        const filtered = React.useMemo(() => {
            const target = new Date(date + 'T00:00:00');
            return legajos.filter(l => l.historial.some(h => {
                // Si es reporte de salidas, buscar SOLO tipos de movimiento 'SALIDA'
                if (type === 'salidas') return h.tipo === 'SALIDA' && isSameDay(h.fecha, target);
                // Si es reporte de entradas, buscar SOLO tipos de movimiento 'ENTRADA' 
                // (Se quita 'CREACI√ìN' para que no figuren archivos nuevos que a√∫n no se han movido)
                return h.tipo === 'ENTRADA' && isSameDay(h.fecha, target);
            }));
        }, [legajos, date, type]);

        React.useEffect(() => { if(open) setSelected(new Set(filtered.map(l => l.id))); }, [open, filtered]);
        
        return (
            <Modal open={open} onClose={onClose} title={type === 'salidas' ? "Libro de Salidas" : "Libro de Entradas"} footer={<><button onClick={onClose} className="px-4 py-2 bg-slate-700 rounded-lg text-xs font-bold">Cerrar</button><button onClick={() => onPrint(filtered.filter(l => selected.has(l.id)), new Date(date + 'T00:00:00'))} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold" disabled={selected.size === 0}>Generar ({selected.size})</button></>}>
                <div className="mb-4"><label className="text-[10px] font-black uppercase text-slate-500 mb-1 block tracking-widest">Fecha</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-full p-3 bg-slate-900 border border-white/10 rounded-xl text-white outline-none"/></div>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                    {filtered.map(l => (
                        <div key={l.id} className="flex items-center gap-3 p-3 bg-white/5 rounded-xl border border-white/5">
                            <input type="checkbox" checked={selected.has(l.id)} onChange={() => { const s = new Set(selected); if(s.has(l.id)) s.delete(l.id); else s.add(l.id); setSelected(s); }} className="w-4 h-4 rounded border-slate-700 bg-slate-800"/>
                            <div className="text-sm text-slate-200"><strong>{l.numero}</strong> - {l.caratula}</div>
                        </div>
                    ))}
                    {filtered.length === 0 && <p className="text-center py-6 text-slate-500 italic">No hay movimientos registrados para esta fecha.</p>}
                </div>
            </Modal>
        );
    }

    // =======================================================
    //  APLICACI√ìN PRINCIPAL
    // =======================================================
    function GestorDeLegajos({ user, onSignOut }) {
        const [legajos, setLegajos] = React.useState([]);
        const [deletedLegajos, setDeletedLegajos] = React.useState([]);
        const [instructores, setInstructores] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [q, setQ] = React.useState("");
        const [current, setCurrent] = React.useState(null);
        const [barcodeActive, setBarcodeActive] = React.useState(true);
        const [scanned, setScanned] = React.useState(false);
        const [highlightedId, setHighlightedId] = React.useState(null);
        const [filtroVencidos, setFiltroVencidos] = React.useState(false);
        
        // Estados Modales
        const [modals, setModals] = React.useState({ 
            new: false, edit: false, salida: false, history: false, 
            barcode: false, trash: false, inst: false, repSal: false, repEnt: false 
        });
        const toggleModal = (key, val) => setModals(prev => ({ ...prev, [key]: val }));

        // Formularios
        const [newForm, setNewForm] = React.useState({ numero: "", caratula: "", instructorId: "" });
        const [editForm, setEditForm] = React.useState({ id: null, numero: "", caratula: "", instructorId: "", vencimiento: "", ubicacionActual: "" });
        const [salidaForm, setSalidaForm] = React.useState({ dependencia: DEPENDENCIAS[0], otraDependencia: "", plazoDias: "" });
        
        const [confirm, setConfirm] = React.useState({ open: false, title: '', msg: '', onOk: null, color: "bg-blue-600" });
        const [alertState, setAlertState] = React.useState({ open: false, title: '', msg: '' });

        const legajoRefs = React.useRef({});

        React.useEffect(() => {
            const unsubLegs = legajosCollectionRef.orderBy("createdAt", "desc").onSnapshot(snap => {
                setLegajos(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                setLoading(false);
            });
            const unsubDels = deletedCollectionRef.orderBy("deletedAt", "desc").onSnapshot(snap => setDeletedLegajos(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
            const unsubInst = instructoresCollectionRef.orderBy("nombre", "asc").onSnapshot(snap => setInstructores(snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
            return () => { unsubLegs(); unsubDels(); unsubInst(); };
        }, []);

        const legajosVencidos = React.useMemo(() => legajos.filter(isOverdue), [legajos]);
        const filteredLegajos = React.useMemo(() => {
            const base = filtroVencidos ? legajosVencidos : legajos;
            const term = q.trim().toLowerCase();
            return term ? base.filter(l => `${l.numero} ${l.caratula}`.toLowerCase().includes(term)) : base;
        }, [legajos, q, filtroVencidos, legajosVencidos]);

        // Manejador del Esc√°ner
        React.useEffect(() => {
            let buffer = ''; let last = 0;
            const handleKey = (e) => {
                if (!barcodeActive || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
                const now = Date.now();
                if (now - last > 100) buffer = '';
                if (e.key === 'Enter') {
                    if (buffer.length > 3) {
                        const clean = buffer.replace(/-/g, '/');
                        const found = legajos.find(l => l.numero === clean);
                        if (found) {
                            setQ(clean); setScanned(true); setHighlightedId(found.id);
                            if (filtroVencidos) setFiltroVencidos(false);
                            setTimeout(() => legajoRefs.current[found.id]?.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
                            setTimeout(() => { setQ(''); setScanned(false); setHighlightedId(null); }, 3000);
                        } else {
                            setAlertState({ open: true, title: 'No Encontrado', msg: `Legajo "${clean}" no hallado.` });
                        }
                    }
                    buffer = '';
                } else if (e.key.length === 1) buffer += e.key;
                last = now;
            };
            window.addEventListener('keydown', handleKey);
            return () => window.removeEventListener('keydown', handleKey);
        }, [legajos, barcodeActive, filtroVencidos]);

        const handleConfirm = (title, msg, onOk, color = "bg-blue-600") => setConfirm({ open: true, title, msg, onOk, color });

        // --- ACCIONES ---
        const onCrearLegajo = async () => {
            const num = newForm.numero.trim();
            if (!validateNumeroExpediente(num)) return setAlertState({ open: true, title: "Error", msg: "Formato de N¬∞ inv√°lido." });
            handleConfirm("Crear Legajo", "¬øDesea dar de alta este expediente?", async () => {
                const inst = instructores.find(i => i.id === newForm.instructorId);
                const hist = { id: uid(), tipo: 'CREACI√ìN', fecha: new Date(), notas: 'Legajo creado.', usuario: user.email };
                await legajosCollectionRef.add({
                    numero: num, caratula: newForm.caratula.trim(), 
                    instructorId: newForm.instructorId || null, instructorNombre: inst ? inst.nombre : "Sin Asignar",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(), enTransito: false,
                    ubicacionActual: { lugar: "Juzgado", desde: new Date() }, vencimiento: null, historial: [hist]
                });
                toggleModal('new', false); setNewForm({numero:"", caratula:"", instructorId:""});
                setConfirm({ ...confirm, open: false });
            });
        };

        const onEditarLegajo = async () => {
            handleConfirm("Guardar Cambios", "¬øConfirmas la modificaci√≥n?", async () => {
                const inst = instructores.find(i => i.id === editForm.instructorId);
                const hist = { id: uid(), tipo: 'MODIFICACI√ìN', fecha: new Date(), notas: `Datos actualizados por ${user.email}.`, usuario: user.email };
                await legajosCollectionRef.doc(editForm.id).update({
                    numero: editForm.numero.trim(), caratula: editForm.caratula.trim(),
                    instructorId: editForm.instructorId || null, instructorNombre: inst ? inst.nombre : "Sin Asignar",
                    'ubicacionActual.lugar': editForm.ubicacionActual.trim(),
                    vencimiento: editForm.vencimiento ? new Date(editForm.vencimiento) : null,
                    historial: firebase.firestore.FieldValue.arrayUnion(hist)
                });
                toggleModal('edit', false); setConfirm({ ...confirm, open: false });
            });
        };

        const onEliminar = (id) => {
            handleConfirm("Eliminar Legajo", "El expediente se mover√° a la papelera.", async () => {
                const doc = await legajosCollectionRef.doc(id).get();
                if(doc.exists) {
                    await deletedCollectionRef.doc(id).set({ ...doc.data(), deletedAt: new Date(), deletedBy: user.email });
                    await legajosCollectionRef.doc(id).delete();
                }
                setConfirm({ ...confirm, open: false });
            }, "bg-rose-600");
        };

        // --- IMPRESIONES ---
        const handlePrintSalidas = (list, date) => {
            const win = window.open('', '', 'height=800,width=800');
            const dStr = date.toLocaleDateString("es-AR", { timeZone: "America/Argentina/Catamarca" });
            win.document.write(`<html><head><title>Reporte Salidas</title><style>@page{size:A4;margin:2cm}body{font-family:sans-serif}.header{text-align:center;position:relative;margin-bottom:2rem}.header h1{margin:0;font-size:1.2rem}.date{position:absolute;top:0;right:0;font-size:0.9rem}table{width:100%;border-collapse:collapse;margin-top:1rem}th,td{border:1px solid #000;padding:10px;text-align:left;vertical-align:top}th{background-color:#f2f2f2;font-size:0.8rem}tr{height:95px}.col-fixed{width:20%}</style></head><body><div class="header"><h1>Juzgado de Ejecuci√≥n Penal N¬∞ 2</h1><div class="date">Fecha: ${dStr}</div></div><h2>Reporte de Salidas Diario</h2><table><thead><tr><th>Legajo N¬∞</th><th>Car√°tula / Destino</th><th class="col-fixed">Sello Dependencia</th><th class="col-fixed">Firma Responsable</th></tr></thead><tbody>`);
            list.forEach(l => {
                const move = l.historial.find(h => h.tipo === 'SALIDA' && isSameDay(h.fecha, date));
                win.document.write(`<tr><td><strong>${l.numero}</strong></td><td>${l.caratula}<br/><small>Destino: ${move?.notas.replace('Enviado a ','') || 'N/D'}</small></td><td></td><td></td></tr>`);
            });
            win.document.write('</tbody></table></body></html>'); win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 400);
        };

        const handlePrintEntradas = (list, date) => {
            const win = window.open('', '', 'height=800,width=800');
            const dStr = date.toLocaleDateString("es-AR", { timeZone: "America/Argentina/Catamarca" });
            win.document.write(`<html><head><title>Planilla Entradas</title><style>@page{size:A4;margin:2cm}body{font-family:sans-serif}.header{text-align:center;position:relative;margin-bottom:2rem}.header h1{margin:0;font-size:1.2rem}.date{position:absolute;top:0;right:0;font-size:0.9rem}table{width:100%;border-collapse:collapse;margin-top:1rem}th,td{border:1px solid #000;padding:10px;text-align:left}th{background-color:#f2f2f2}tr{height:60px}</style></head><body><div class="header"><h1>Juzgado de Ejecuci√≥n Penal N¬∞ 2</h1><div class="date">Fecha: ${dStr}</div></div><h2>Planilla de Recepci√≥n</h2><table><thead><tr><th>Legajo N¬∞</th><th>Car√°tula / Instructor</th><th>Fecha Recepci√≥n</th><th>Firma</th></tr></thead><tbody>`);
            list.forEach(l => { win.document.write(`<tr><td><strong>${l.numero}</strong></td><td>${l.caratula}<br/><small>Instructor: ${l.instructorNombre}</small></td><td></td><td></td></tr>`); });
            win.document.write('</tbody></table></body></html>'); win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 400);
        };

        const handlePrintVista = () => {
            const win = window.open('', '', 'height=800,width=900');
            const dStr = new Date().toLocaleDateString("es-AR", { timeZone: "America/Argentina/Catamarca" });
            const sub = filtroVencidos ? "Legajos Vencidos" : "Listado Filtrado";
            win.document.write(`<html><head><title>Vista Impresa</title><style>@page{size:A4;margin:1.5cm}body{font-family:sans-serif;font-size:10pt;color:#111}.h{text-align:center;border-bottom:2px solid #000;margin-bottom:20px;padding-bottom:10px}table{width:100%;border-collapse:collapse}th,td{border:1px solid #000;padding:7px;text-align:left}th{background:#f0f0f0;text-transform:uppercase;font-size:8pt}.vencido{color:red;font-weight:bold}</style></head><body><div style="text-align:right">Fecha: ${dStr}</div><div class="h"><h1>Juzgado de Ejecuci√≥n Penal N¬∞ 2</h1><h3>${sub} ${q ? `(Filtro: "${q}")` : ''}</h3></div><table><thead><tr><th>N¬∞</th><th>Car√°tula</th><th>Instructor</th><th>Ubicaci√≥n</th><th>Vencimiento</th><th>Estado</th></tr></thead><tbody>`);
            filteredLegajos.forEach(l => {
                const over = isOverdue(l);
                win.document.write(`<tr><td>${l.numero}</td><td>${l.caratula}</td><td>${l.instructorNombre}</td><td>${l.ubicacionActual?.lugar}</td><td>${fmtDateTime(l.vencimiento)}</td><td>${over ? 'VENCIDO' : l.enTransito ? 'TR√ÅNSITO' : 'JUZGADO'}</td></tr>`);
            });
            win.document.write('</tbody></table></body></html>'); win.document.close();
            setTimeout(() => { win.print(); win.close(); }, 400);
        };

        return (
            <div className="min-h-screen pb-12">
                <BackgroundGradientAnimation />
                <div className="relative z-10">
                    <header className="glass-panel border-b border-white/10 p-4 mb-6 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                            <div className="flex items-center gap-4">
                                <div className="bg-blue-600 p-2.5 rounded-2xl shadow-lg shadow-blue-900/40">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 11H5m14 0a2 2 0 0 1 12 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 0 1 2-2m0 0V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2M7 7h10" /></svg>
                                </div>
                                <div>
                                    <h1 className="text-xl md:text-2xl font-extrabold text-white tracking-tight leading-none mb-1">EESS Dashboard</h1>
                                    <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest leading-none">Juzgado de Ejecuci√≥n Penal N¬∞ 2</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-right hidden sm:block border-r border-white/10 pr-4">
                                    <p className="text-xs font-semibold text-slate-300 leading-none mb-1">{user.email}</p>
                                    <button onClick={onSignOut} className="text-[10px] text-rose-400 font-bold hover:text-rose-300 uppercase tracking-widest">Salir</button>
                                </div>
                                {legajosVencidos.length > 0 && (
                                    <button onClick={() => setFiltroVencidos(true)} className="flex items-center gap-2 px-3 py-2 bg-rose-500/20 text-rose-400 border border-rose-500/30 rounded-xl animate-pulse hover:bg-rose-500/30">
                                        <span className="w-2 h-2 bg-rose-500 rounded-full"></span>
                                        <span className="text-xs font-bold">{legajosVencidos.length} VENCIDOS</span>
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 lg:px-8 space-y-6">
                        {/* PANEL BENTO BOX */}
                        <section className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div className="glass-panel p-5 rounded-3xl flex flex-col shadow-lg h-full">
                                <h2 className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Operaciones</h2>
                                <div className="flex flex-col gap-2 flex-grow justify-center">
                                    <button onClick={() => toggleModal('new', true)} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black text-xs tracking-widest flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-900/20">‚ûï NUEVO LEGAJO</button>
                                </div>
                            </div>
                            <div className="glass-panel p-5 rounded-3xl flex flex-col shadow-lg h-full">
                                <h2 className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Auditor√≠a Diaria</h2>
                                <div className="flex flex-col gap-2 flex-grow justify-center">
                                    <button onClick={() => toggleModal('repEnt', true)} className="w-full py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-2xl font-black text-xs tracking-widest flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-emerald-900/20">üì• ENTRADAS</button>
                                    <button onClick={() => toggleModal('repSal', true)} className="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black text-xs tracking-widest flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-900/20">üì§ SALIDAS</button>
                                </div>
                            </div>
                            <div className="glass-panel p-5 rounded-3xl flex flex-col shadow-lg h-full">
                                <h2 className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3">Configuraci√≥n</h2>
                                <div className="flex flex-col gap-2 flex-grow justify-center">
                                    <button onClick={() => toggleModal('inst', true)} className="w-full py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-2xl font-black text-xs tracking-widest flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-purple-900/20">üë• PERSONAL</button>
                                    <button onClick={() => toggleModal('trash', true)} className="w-full py-3 bg-amber-600 hover:bg-amber-500 text-white rounded-2xl font-black text-xs tracking-widest flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-amber-900/20 relative">
                                        üóëÔ∏è PAPELERA
                                        {deletedLegajos.length > 0 && <span className="ml-2 bg-white text-amber-600 text-[10px] font-black w-5 h-5 rounded-full flex items-center justify-center">{deletedLegajos.length}</span>}
                                    </button>
                                </div>
                            </div>
                        </section>

                        {/* BARRA DE HERRAMIENTAS - PROPORCIONAL */}
                        <div className="flex flex-col lg:flex-row gap-2 items-stretch">
                            <div className="relative flex-[3] group">
                                <span className="absolute inset-y-0 left-4 flex items-center text-slate-500 group-focus-within:text-blue-400 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </span>
                                <input value={q} onChange={e => setQ(e.target.value)} placeholder="Filtrar expediente o car√°tula..." className={`w-full pl-12 pr-4 py-4 glass-panel rounded-2xl outline-none border-transparent focus:border-blue-500/50 transition-all text-sm font-medium text-white ${scanned ? 'barcode-scanned' : ''}`}/>
                            </div>
                            <button onClick={handlePrintVista} className="flex-1 px-5 glass-panel rounded-2xl font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-white/10 transition-colors py-4 lg:py-0 shadow-lg">üñ®Ô∏è Imprimir</button>
                            <button onClick={() => setBarcodeActive(!barcodeActive)} className={`flex-1 px-5 rounded-2xl font-bold text-xs uppercase tracking-widest flex items-center justify-center gap-2 transition-all py-4 lg:py-0 shadow-lg ${barcodeActive ? 'bg-emerald-500/20 text-emerald-400 border border-emerald-500/30' : 'bg-slate-700/50 text-slate-500 border border-white/5'}`}>
                                <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" /></svg>
                                {barcodeActive ? 'Lector On' : 'Lector Off'}
                            </button>
                        </div>

                        {/* LISTADO */}
                        <div className="space-y-4">
                            {filtroVencidos && (
                                <div className="flex justify-between items-center bg-rose-500/10 p-3 rounded-2xl border border-rose-500/20">
                                    <span className="text-xs font-bold text-rose-400 flex items-center gap-2"><span className="w-2 h-2 bg-rose-500 rounded-full"></span> S√ìLO LEGAJOS VENCIDOS</span>
                                    <button onClick={() => setFiltroVencidos(false)} className="text-[10px] font-black uppercase text-rose-400 hover:underline px-2">Limpiar</button>
                                </div>
                            )}

                            <div className="hidden md:block overflow-hidden rounded-3xl glass-panel shadow-2xl border border-white/10">
                                <table className="w-full text-sm">
                                    <thead className="bg-white/5 text-[10px] font-black uppercase tracking-widest text-slate-500">
                                        <tr>
                                            <th className="p-4 text-left">N¬∞ Legajo</th>
                                            <th className="p-4 text-left">Car√°tula / Instructor</th>
                                            <th className="p-4 text-left">Localizaci√≥n</th>
                                            <th className="p-4 text-left">Vencimiento</th>
                                            <th className="p-4 text-left">Estado</th>
                                            <th className="p-4 text-right">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {filteredLegajos.map(l => (
                                            <tr key={l.id} ref={el => legajoRefs.current[l.id] = el} className={`border-t border-white/5 transition-all ${l.id === highlightedId ? 'highlighted-row' : ''}`}>
                                                <td className="p-4 font-extrabold text-white text-lg">{l.numero}</td>
                                                <td className="p-4">
                                                    <div className="font-semibold text-slate-200 leading-tight mb-1">{l.caratula}</div>
                                                    <div className="text-[9px] font-bold text-slate-500 uppercase">üë§ {l.instructorNombre}</div>
                                                </td>
                                                <td className="p-4 font-semibold text-white">{l.ubicacionActual?.lugar}</td>
                                                <td className="p-4 font-semibold text-white">{fmtDateTime(l.vencimiento)}</td>
                                                <td className="p-4">{isOverdue(l) ? <Pill color="red">Vencido</Pill> : l.enTransito ? <Pill color="blue">Tr√°nsito</Pill> : <Pill color="green">Juzgado</Pill>}</td>
                                                <td className="p-4 text-right">
                                                    <div className="flex gap-1 justify-end">
                                                        {l.enTransito ? (
                                                            <ActionButton onClick={() => handleConfirm("Registrar Entrada", "¬øConfirma reingreso?", async () => { await legajosCollectionRef.doc(l.id).update({ enTransito: false, ubicacionActual: { lugar: "Juzgado", desde: new Date() }, vencimiento: null, historial: firebase.firestore.FieldValue.arrayUnion({ id: uid(), tipo: 'ENTRADA', fecha: new Date(), notas: 'Regresa a Juzgado.', usuario: user.email }) }); setConfirm({ ...confirm, open: false }); }, "bg-emerald-600")} icon="üì•" color="green" />
                                                        ) : (
                                                            <ActionButton onClick={() => { setCurrent(l); setSalidaForm({ dependencia: DEPENDENCIAS[0], otraDependencia: "", plazoDias: "" }); toggleModal('salida', true); }} icon="üì§" color="blue" />
                                                        )}
                                                        <ActionButton onClick={() => { setCurrent(l); toggleModal('history', true); }} icon="üïò" />
                                                        <ActionButton onClick={() => { setCurrent(l); setEditForm({ id: l.id, numero: l.numero, caratula: l.caratula, instructorId: l.instructorId || "", ubicacionActual: l.ubicacionActual?.lugar || "", vencimiento: l.enTransito ? dateToInputFormat(l.vencimiento) : '' }); toggleModal('edit', true); }} icon="üìù" />
                                                        <ActionButton onClick={() => { setCurrent(l); toggleModal('barcode', true); }} icon="üè∑Ô∏è" />
                                                        <ActionButton onClick={() => onEliminar(l.id)} icon="üóëÔ∏è" color="red" />
                                                    </div>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </main>
                </div>

                {/* MODALES */}
                <BarcodeModal open={modals.barcode} onClose={() => toggleModal('barcode', false)} legajo={current} />
                <InstructoresModal open={modals.inst} onClose={() => toggleModal('inst', false)} instructores={instructores} legajos={legajos} onAdd={async (n) => await instructoresCollectionRef.add({nombre: n})} onEdit={async (id, n) => await instructoresCollectionRef.doc(id).update({nombre: n})} onDelete={async (id) => await instructoresCollectionRef.doc(id).delete()} onAlert={m => setAlertState({open: true, title: "Aviso", msg: m})} />
                <ReporteModal open={modals.repSal} onClose={() => toggleModal('repSal', false)} type="salidas" legajos={legajos} onPrint={handlePrintSalidas} />
                <ReporteModal open={modals.repEnt} onClose={() => toggleModal('repEnt', false)} type="entradas" legajos={legajos} onPrint={handlePrintEntradas} />

                <Modal open={modals.new} onClose={() => toggleModal('new', false)} title="Nuevo Expediente" footer={<><button onClick={() => toggleModal('new', false)} className="px-6 py-2.5 glass-panel rounded-xl text-xs font-bold uppercase">Cancelar</button><button onClick={onCrearLegajo} className="px-6 py-2.5 bg-blue-600 text-white rounded-xl text-xs font-bold uppercase">Confirmar</button></>}>
                    <div className="space-y-4 text-sm font-medium">
                        <div><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1 block">N¬∞ Legajo</label><input value={newForm.numero} onChange={e => setNewForm({...newForm, numero: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-2xl p-4 text-white font-mono" placeholder="Ej: 1234/2024"/></div>
                        <div><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Car√°tula</label><textarea value={newForm.caratula} onChange={e => setNewForm({...newForm, caratula: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-2xl p-4 text-white h-24"/></div>
                        <div><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Instructor</label><select value={newForm.instructorId} onChange={e => setNewForm({...newForm, instructorId: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-2xl p-4 text-white"><option value="">Sin Asignar</option>{instructores.map(i => <option key={i.id} value={i.id}>{i.nombre}</option>)}</select></div>
                    </div>
                </Modal>

                <Modal open={modals.edit} onClose={() => toggleModal('edit', false)} title="Editar Datos" footer={<><button onClick={() => toggleModal('edit', false)} className="px-6 py-2.5 glass-panel rounded-xl text-xs font-bold">Cerrar</button><button onClick={onEditarLegajo} className="px-6 py-2.5 bg-blue-600 text-white rounded-xl text-xs font-bold uppercase">Guardar</button></>}>
                    <div className="space-y-4 text-sm font-medium">
                        <div className="grid grid-cols-2 gap-4">
                            <div><label className="text-[10px] font-black text-slate-500 uppercase mb-1 block tracking-widest">N√∫mero</label><input value={editForm.numero} onChange={e => setEditForm({...editForm, numero: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white font-mono"/></div>
                            <div><label className="text-[10px] font-black text-slate-500 uppercase mb-1 block tracking-widest">Instructor</label><select value={editForm.instructorId} onChange={e => setEditForm({...editForm, instructorId: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white">{instructores.map(i => <option key={i.id} value={i.id}>{i.nombre}</option>)}</select></div>
                        </div>
                        <div><label className="text-[10px] font-black text-slate-500 uppercase mb-1 block tracking-widest">Car√°tula</label><textarea value={editForm.caratula} onChange={e => setEditForm({...editForm, caratula: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white h-20"/></div>
                        <div><label className="text-[10px] font-black text-slate-500 uppercase mb-1 block tracking-widest">Ubicaci√≥n Manual</label><input value={editForm.ubicacionActual} onChange={e => setEditForm({...editForm, ubicacionActual: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white"/></div>
                        {current?.enTransito && (
                            <div><label className="text-[10px] font-black text-blue-400 uppercase mb-1 block tracking-widest">Vencimiento</label><input type="datetime-local" value={editForm.vencimiento} onChange={e => setEditForm({...editForm, vencimiento: e.target.value})} className="w-full bg-slate-950/50 border border-blue-500/30 rounded-xl p-3 text-white"/></div>
                        )}
                    </div>
                </Modal>

                <Modal open={modals.history} onClose={() => toggleModal('history', false)} title={`Historial: ${current?.numero}`} footer={<button onClick={() => toggleModal('history', false)} className="px-6 py-2.5 glass-panel rounded-xl text-xs font-bold">Cerrar</button>}>
                    <div className="space-y-4">
                        {current?.historial && [...current.historial].sort((a,b) => (b.fecha?.toMillis ? b.fecha.toMillis() : new Date(b.fecha).getTime()) - (a.fecha?.toMillis ? a.fecha.toMillis() : new Date(a.fecha).getTime())).map(h => (
                            <div key={h.id} className="p-4 bg-white/5 rounded-2xl border border-white/5">
                                <div className="flex justify-between items-start mb-2">
                                    <span className={`px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-widest ${h.tipo === 'SALIDA' ? 'bg-blue-500 text-white' : h.tipo === 'ENTRADA' ? 'bg-emerald-500 text-white' : 'bg-slate-700 text-slate-200'}`}>{h.tipo}</span>
                                    <span className="text-[10px] font-mono text-slate-500">{fmtDateTime(h.fecha)}</span>
                                </div>
                                <p className="text-sm text-slate-300 mb-1">{h.notas}</p>
                                <p className="text-[9px] font-bold text-slate-600 uppercase">üë§ Usuario: {h.usuario}</p>
                            </div>
                        ))}
                    </div>
                </Modal>

                <Modal open={modals.salida} onClose={() => toggleModal('salida', false)} title="Registrar Salida" footer={<><button onClick={() => toggleModal('salida', false)} className="px-6 py-2.5 glass-panel rounded-xl text-xs font-bold">Cancelar</button><button onClick={async () => {
                    const dest = salidaForm.dependencia === 'Otra' ? salidaForm.otraDependencia.trim() : salidaForm.dependencia;
                    if(!dest) return setAlertState({open:true, title:"Error", msg:"Defina un destino."});
                    handleConfirm("Autorizar Salida", `¬øAutoriza el env√≠o a ${dest}?`, async () => {
                        const now = new Date(); const venc = salidaForm.plazoDias ? addDays(now, salidaForm.plazoDias) : null;
                        const hist = { id: uid(), tipo: 'SALIDA', fecha: now, notas: `Enviado a ${dest}.`, plazo: salidaForm.plazoDias || 0, vencimiento: venc, usuario: user.email };
                        await legajosCollectionRef.doc(current.id).update({ enTransito: true, ubicacionActual: { lugar: dest, desde: now }, vencimiento: venc, historial: firebase.firestore.FieldValue.arrayUnion(hist) });
                        toggleModal('salida', false); setConfirm({ ...confirm, open: false });
                    });
                }} className="px-6 py-2.5 bg-blue-600 text-white rounded-xl text-xs font-bold uppercase shadow-lg shadow-blue-900/40">Confirmar Salida</button></>}>
                    <div className="space-y-4 text-sm font-medium">
                        <div><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Destino</label><select value={salidaForm.dependencia} onChange={e => setSalidaForm({...salidaForm, dependencia: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white">{DEPENDENCIAS.map(d => <option key={d} value={d} className="bg-slate-900">{d}</option>)}</select></div>
                        {salidaForm.dependencia === 'Otra' && (<div><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Especifique</label><input value={salidaForm.otraDependencia} onChange={e => setSalidaForm({...salidaForm, otraDependencia: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white"/></div>)}
                        <div><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Plazo (D√≠as)</label><input type="number" min="0" value={salidaForm.plazoDias} onChange={e => setSalidaForm({...salidaForm, plazoDias: e.target.value})} className="w-full bg-slate-950/50 border border-white/10 rounded-xl p-3 text-white"/></div>
                    </div>
                </Modal>

                <Modal open={modals.trash} onClose={() => toggleModal('trash', false)} title="Registro de Eliminados" maxWidth="max-w-4xl" footer={<button onClick={() => toggleModal('trash', false)} className="px-6 py-2 bg-slate-700 rounded-xl text-xs font-bold">Cerrar</button>}>
                    <div className="overflow-x-auto text-xs"><table className="w-full"><thead className="bg-white/5 text-slate-500 uppercase tracking-widest"><tr><th className="p-3 text-left">Expediente</th><th className="p-3 text-left">Borrado</th><th className="p-3 text-right">Acci√≥n</th></tr></thead><tbody>{deletedLegajos.map(l => (<tr key={l.id} className="border-t border-white/5"><td className="p-3 font-bold text-white">{l.numero}<br/><span className="text-[10px] text-slate-500 font-medium normal-case">{l.caratula}</span></td><td className="p-3 text-slate-500 leading-tight">{fmtDateTime(l.deletedAt)}<br/><span className="text-[8px] uppercase text-slate-600">Por: {l.deletedBy}</span></td><td className="p-3 text-right"><button onClick={async () => { const {deletedAt, deletedBy, ...rest} = l; await legajosCollectionRef.doc(l.id).set({...rest, historial: [{id: uid(), tipo:'RESTAURACI√ìN', fecha: new Date(), notas: 'Restaurado.', usuario: user.email}, ...l.historial]}); await deletedCollectionRef.doc(l.id).delete(); }} className="px-3 py-1.5 bg-blue-600/20 text-blue-400 rounded-lg font-black uppercase">Restaurar</button></td></tr>))}</tbody></table></div>
                </Modal>

                {confirm.open && (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md">
                        <div className="max-w-md w-full glass-panel rounded-[32px] p-8 text-center border-white/10 shadow-2xl">
                            <h3 className="text-xl font-black text-white mb-3 tracking-tighter">{confirm.title}</h3>
                            <p className="text-slate-400 font-medium mb-8 leading-relaxed text-sm">{confirm.msg}</p>
                            <div className="flex gap-3"><button onClick={() => setConfirm({ ...confirm, open: false })} className="flex-1 py-3 glass-panel rounded-2xl font-bold text-xs uppercase tracking-widest text-slate-300">Cerrar</button><button onClick={confirm.onOk} className={`flex-1 py-3 ${confirm.color} text-white rounded-2xl font-bold text-xs uppercase tracking-widest shadow-lg shadow-blue-900/40 transition-transform active:scale-95`}>Continuar</button></div>
                        </div>
                    </div>
                )}

                {alertState.open && (
                    <div className="fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-950/90 backdrop-blur-md">
                        <div className="max-w-md w-full glass-panel rounded-[32px] p-8 text-center border-rose-500/20 shadow-2xl">
                            <h3 className="text-xl font-black text-white mb-3 tracking-tighter">{alertState.title}</h3>
                            <p className="text-slate-400 font-medium mb-8 text-sm">{alertState.msg}</p>
                            <button onClick={() => setAlertState({ ...alertState, open: false })} className="w-full py-3 bg-rose-600 text-white rounded-2xl font-bold text-xs uppercase tracking-widest">Entendido</button>
                        </div>
                    </div>
                )}
            </div>
        );
    }
    
    function LoginScreen() {
        const [email, setEmail] = React.useState("");
        const [pass, setPass] = React.useState("");
        const [loading, setLoading] = React.useState(false);
        const handleLogin = (e) => {
            e.preventDefault(); setLoading(true);
            auth.signInWithEmailAndPassword(email, pass).catch(err => { console.error(err); setLoading(false); });
        };
        return (
            <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4 relative overflow-hidden">
                <BackgroundGradientAnimation />
                <div className="max-w-sm w-full glass-panel rounded-[48px] p-10 border-white/5 shadow-2xl relative z-10 text-center">
                    <div className="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6 rotate-3 shadow-xl shadow-blue-900/40">
                         <svg xmlns="http://www.w3.org/2000/svg" className="w-10 h-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2.5} d="M19 11H5m14 0a2 2 0 0 1 12 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 0 1 2-2m0 0V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2M7 7h10" /></svg>
                    </div>
                    <h2 className="text-3xl font-black text-white tracking-tighter mb-2">CONTROL JEP2</h2>
                    <p className="text-[10px] font-black text-slate-500 uppercase tracking-[4px] mb-10">Poder Judicial</p>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="Email Judicial" className="w-full p-4 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm font-medium" required />
                        <input type="password" value={pass} onChange={e => setPass(e.target.value)} placeholder="Contrase√±a" className="w-full p-4 bg-white/5 border border-white/10 rounded-2xl text-white outline-none focus:ring-2 focus:ring-blue-500 transition-all text-sm font-medium" required />
                        <button type="submit" disabled={loading} className="w-full py-4 bg-blue-600 text-white rounded-2xl font-black uppercase tracking-[2px] text-[10px] hover:bg-blue-500 shadow-xl transition-all disabled:bg-slate-800 tracking-widest">{loading ? 'AUTENTICANDO...' : 'INICIAR SESI√ìN'}</button>
                    </form>
                    <p className="mt-10 text-[9px] text-center font-bold text-slate-600 uppercase tracking-widest opacity-50 font-black">¬© 2025 Catamarca - Poder Judicial</p>
                </div>
            </div>
        );
    }

    function App() {
        const [u, setU] = React.useState(null);
        const [l, setL] = React.useState(true);
        React.useEffect(() => { const unsub = auth.onAuthStateChanged(user => { setU(user); setL(false); }); return unsub; }, []);
        if (l) return <div className="min-h-screen bg-slate-950 flex items-center justify-center"><div className="w-12 h-12 border-4 border-blue-600/20 border-t-blue-600 rounded-full animate-spin"></div></div>;
        return u ? <GestorDeLegajos user={u} onSignOut={() => auth.signOut()} /> : <LoginScreen />;
    }
        
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    </script>
</body>
</html>
